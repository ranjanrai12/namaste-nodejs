# Episode-04 | Sending Emails using Amazon SES

## Overview

Amazon Simple Email Service (SES) is a cost-effective, flexible, and scalable email-sending service.
In this guide, we’ll walk through how to configure **Amazon SES** and send emails from your **Node.js backend** using **AWS SDK v3**.

## Step-by-Step Setup

### 1. Create an IAM User for SES

- Go to **AWS Console → IAM**.
- Click **Users → Create user**.
- Enter a username (e.g. `ses-user`).
- Select Attach policies directly.
- Search for and attach: `AmazonSESFullAccess`
- Click **Next → Create user**.

### 2. Setup Amazon SES

- In AWS Console, search for **Amazon SES** and open it.
- Go to **Account dashboard** → click Set up **account**.
- On the setup page, click **Create identity**.
- Under **Identity type**, choose **Domain**.
- Enter your domain (e.g. devmatches.xyz).
- Go to Identity type
  - Click **Easy DKIM** and select `RSA_2048_BIT`
- Click **Create identity**

After creation:

- You’ll see **three CNAME** records generated by SES.
- These are **DKIM verification records**.

**Add to Cloudflare (or your DNS Provider)**

- Go to **Cloudflare → DNS → Records**.
- Add each CNAME record provided by SES.
- **Turn off the orange cloud — set Proxy status → DNS only.**
- Wait for SES verification (typically 5–10 minutes; can take longer).

AMAZON SES -> Get Setup page -> Request the production access - Mail Type(Transactional) - website url(`https://devmatches.xyz/`) - Enter addition mail (optional) - acknowledge and save

### 3. Create Access Keys

- Go to **IAM → Users → `ses-user` → Security credentials**.
- Click **Create access key.**
- Choose **Use case → Other → Create access key.**
- Copy your:
  - **Access key ID**
  - **Secret access key**

⚠️ Keep these safe — they won’t be shown again.

### 4. Go Set Environment Variables

AWS_ACCESS_KEY_ID=YOUR_ACCESS_KEY_ID
AWS_SECRET_ACCESS_KEY=YOUR_SECRET_ACCESS_KEY

### 5. Node.js Implementation (AWS SDK v3)

- Install Dependencies

```bash
npm install @aws-sdk/client-ses
```

- search for **AWS SES nodejs documentation** (We are using v3 version)

  - https://docs.aws.amazon.com/sdk-for-javascript/v3/developer-guide/ses-examples-sending-email.html

- Get started -> Get started with nodejs

- Create **sesClient.js** in local and copy paste code from here https://github.com/awsdocs/aws-doc-sdk-examples/blob/main/javascriptv3/example_code/ses/src/libs/sesClient.js.

#### Create SES Client

```js
const { SESClient } = require("@aws-sdk/client-ses");
// Set the AWS Region.
const REGION = "ap-south-1";
// Create SES service object.
const sesClient = new SESClient({
  region: REGION,
  credentials: {
    accessKeyId: process.env.AWS_ACCESS_KEY_ID,
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
  },
});

module.exports = { sesClient };
```

#### Create sendEmail.js

```js
const { SendEmailCommand } = require("@aws-sdk/client-ses");
const { sesClient } = require("../utils/sesClient");

const createSendEmailCommand = (toAddress, fromAddress) => {
  const subject = "✨ Welcome to DevMatches – Let’s Get Started!";
  const htmlBody = `
  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>${subject}</title>
    <style>
      body {
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background-color: #f9f9f9;
        margin: 0;
        padding: 0;
      }
      .container {
        background: #ffffff;
        margin: 40px auto;
        padding: 30px;
        max-width: 600px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      }
      .header {
        text-align: center;
        border-bottom: 2px solid #eeeeee;
        padding-bottom: 10px;
      }
      .header h1 {
        color: #4f46e5;
        margin: 0;
        font-size: 26px;
      }
      .content {
        padding: 20px 0;
        color: #333333;
        line-height: 1.6;
      }
      .button {
        display: inline-block;
        padding: 12px 25px;
        background-color: #4f46e5;
        color: white !important;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        margin-top: 20px;
      }
      .footer {
        text-align: center;
        color: #999999;
        font-size: 12px;
        padding-top: 20px;
      }
      @media (max-width: 600px) {
        .container {
          width: 95%;
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Welcome to DevMatches 🎉</h1>
      </div>
      <div class="content">
        <p>Hi there 👋,</p>
        <p>We’re thrilled to have you join <strong>DevMatches</strong> — a place where developers and opportunities meet.</p>
        <p>Click the button below to verify your email and start building meaningful connections:</p>
        <a href="https://devmatches.xyz/verify?email=${encodeURIComponent(
          toAddress
        )}" class="button">Verify My Email</a>
        <p>If you didn’t request this, please ignore this email.</p>
      </div>
      <div class="footer">
        <p>© ${new Date().getFullYear()} DevMatches. All rights reserved.</p>
      </div>
    </div>
  </body>
  </html>`;

  const textBody = `
  Welcome to DevMatches!

  We're excited to have you onboard.
  Verify your email to get started:
  https://devmatches.xyz/verify?email=${toAddress}

  — The DevMatches Team
  `;

  return new SendEmailCommand({
    Destination: {
      ToAddresses: [toAddress],
    },
    Message: {
      Body: {
        Html: {
          Charset: "UTF-8",
          Data: htmlBody,
        },
        Text: {
          Charset: "UTF-8",
          Data: textBody,
        },
      },
      Subject: {
        Charset: "UTF-8",
        Data: subject,
      },
    },
    Source: fromAddress,
  });
};

const run = async () => {
  const sendEmailCommand = createSendEmailCommand(
    "ranjankrrai93@gmail.com",
    "ranjan@devmatches.xyz"
  );

  try {
    return await sesClient.send(sendEmailCommand);
  } catch (caught) {
    if (caught instanceof Error && caught.name === "MessageRejected") {
      return caught;
    }
    throw caught;
  }
};

module.exports = { run };
```

#### Integrate with Express Route

Request router, trigger the email when a new connection request is sent.

```js
requestRouter.post("/send/:status/:toUserId", userAuth, async (req, res) => {
  try {
    const { _id: fromUserId } = req.user;
    const toUserId = req.params.toUserId;
    const status = req.params.status;
    // allowed only ignored and interested in send request
    const allowedStatus = ["ignored", "interested"];
    if (!allowedStatus.includes(status)) {
      return res
        .status(400)
        .json({ message: "Invalid status type: " + status });
    }

    // If there is any existing connection request
    /**
     * $or: [
     *   { fromUserId: fromUserId, toUserId: toUserId },
     *   { fromUserId: toUserId, toUserId: fromUserId }
     * ]
     * This query checks for a connection request where either:
     * - The current user (fromUserId) has sent a request to the target user (toUserId)
     * - The target user (toUserId) has sent a request to the current user (fromUserId)
     * If either condition is true, it means there is already a connection request between these two users.
     */
    const existingConnectionRequest = await ConnectionRequest.findOne({
      $or: [
        {
          fromUserId,
          toUserId,
        },
        {
          fromUserId: toUserId,
          toUserId: fromUserId,
        },
      ],
    });
    // Check if toUserId exists
    const toUser = await User.findById(toUserId);
    if (!toUser) {
      return res.status(400).json({ message: "User not found" });
    }

    if (existingConnectionRequest) {
      return res.status(400).json({ message: "Connection already exists" });
    }
    // Create a new connection request
    const connectionRequest = new ConnectionRequest({
      fromUserId,
      toUserId,
      status,
    });
    const data = await connectionRequest.save();

    const emailRes = await sendEmail.run();
    console.log("emailRes", emailRes);

    res.status(200).json({
      status: `${req.user.firstName} is ${status} in ${toUser.firstName}`,
      data,
    });
  } catch (err) {
    res.status(500).send("Error: " + err.message);
  }
});
```
